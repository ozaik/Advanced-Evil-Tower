map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name localhost;

  add_header Content-Security-Policy "frame-ancestors http://localhost http://localhost:8080" always;

  # Docker internal DNS resolver (needed for browser-<sid>)
  resolver 127.0.0.11 ipv6=off valid=10s;

  # ----------------------------
  # Frontend (Next.js)
  # ----------------------------
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://web:3000;
  }

  # ----------------------------
  # Auth check (gateway)
  # ----------------------------
  location = /_auth {
    internal;
    proxy_set_header Host $host;
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Session-Id $sid;
    proxy_pass http://gateway:8080/auth/verify;
  }

  # ============================================================
  # Remote Browser UI (noVNC)
  # ============================================================

  # /s/<sid> -> /s/<sid>/
  location ~ "^/s/([0-9A-Za-z_-]{8,64})$" {
    return 308 /s/$1/;
  }

  # /s/<sid>/
  location ~ "^/s/([0-9A-Za-z_-]{8,64})/$" {
    set $sid $1;
    # Redirect to vnc_lite.html with query parameters, preserving existing args
    return 302 $scheme://$http_host/s/$sid/vnc_lite.html?autoconnect=1&resize=scale&scaleViewport=true&path=s/$sid/websockify&show_dot=false&show_status=false&$args;
  }

  # /s/<sid>/vnc_lite.html - serve the noVNC interface
  location ~ "^/s/([0-9A-Za-z_-]{8,64})/vnc_lite\.html$" {
    set $sid $1;

    proxy_set_header X-Session-Id $sid;
    auth_request /_auth;
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;

    proxy_redirect off;
    proxy_pass http://browser-$sid:6080/vnc_lite.html$is_args$args;
    
    # Inject custom CSS to hide noVNC status bar and remove canvas border
    sub_filter '</head>' '<style>#noVNC_status_bar,.noVNC_status,.noVNC_status_bar{display:none!important;height:0!important;}#noVNC_canvas,canvas{border:none!important;outline:none!important;box-shadow:none!important;}</style></head>';
    sub_filter_once on;
  }

  # /s/<sid>/<path>
  location ~ "^/s/([0-9A-Za-z_-]{8,64})/(.+)$" {
    set $sid $1;
    set $path $2;

    proxy_set_header X-Session-Id $sid;
    auth_request /_auth;
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;

    proxy_redirect off;
    proxy_pass http://browser-$sid:6080/$path;
  }

  # ============================================================
  # Playwright / Session API (if your session container exposes it)
  # ============================================================

  location ~ "^/api/s/([0-9A-Za-z_-]{8,64})$" {
    return 308 /api/s/$1/;
  }

  location ~ "^/api/s/([0-9A-Za-z_-]{8,64})/(.*)$" {
    set $sid $1;
    set $path $2;

    proxy_set_header X-Session-Id $sid;
    auth_request /_auth;

    proxy_redirect off;
    proxy_pass http://browser-$sid:3000/$path;
  }
}
